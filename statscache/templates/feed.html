{% extends "layout.html" %}
{% block title %}{{ plugin.name.lower() }}{% endblock %}
{% block byline %}direct feed{% endblock %}
{% block head %}
	<meta name="description" content="Raw feed of '{{ plugin.ident }}' model">
	<link rel="stylesheet"
		  type="text/css"
		  href="{{ url_for('static', filename='style/feed.css') }}" >
	</link>
	<script type="application/javascript">
		String.prototype.format = function (o) {
		    return this.replace(/{([^{}]*)}/g,
		        function (a, b) {
		            var r = o[b];
		            return typeof r === 'string' || typeof r === 'number' ? r : a;
		        }
		    );
		};

		String.prototype.htmlEscape = function () {
			var map = {
				"&": "&amp;",
				"<": "&lt;",
				">": "&gt;",
				'"': '&quot;',
				"'": '&#39;',
				"/": '&#x2F;'
			};
			return this.replace(/[&<>"'\/]/g, function (symbol) {
				return map[symbol];
			});
		}

		var initialized = false;
		var feed = "{{ url_for('plugin_model', ident=plugin.ident) }}";
		var rows_per_page = 100;
		var page = 1;
		var keys;
		var template;
		/* TODO: variable time interval */
//		var stop = Date.parse({{ '????? '}});
//		var start = Date.parse({{ '?????' }});
		function render(data) {
			if (!initialized) {
				/* execute this once for the first AJAX response */
				keys = Object.keys(data[0]);
				keys.splice(keys.indexOf('timestamp'), 1);
				keys.unshift('timestamp');
				$('thead').html("<tr>" + keys.map(function (s) {
					return '<th>' + s + '</th>';
				}).join("") + "</tr>");
				template = "<tr>" + keys.map(function (s) {
					return '<td>{' + s + '}</td>';
				}).join("") + "</tr>";
				initialized = true;
			}
			data.forEach(function (row) {
				t = new Date();
				t.setTime(row.timestamp*1000);
				row.timestamp = t.toUTCString();
				keys.forEach(function (key) {
					row[key] = String(row[key]).htmlEscape();
				});
				$('tbody').append(template.format(row));
			});
			/* TODO: render a configurable graph */
		}

		function request() {
			$('img#spinwheel').show();
			$.ajax(
				feed + "?" + $.param(
					{
						'rows_per_page': rows_per_page,
						'page': page
					}
				),
				{
					'dataType': 'json',
					'complete': function (request, status) {
						$('img#spinwheel').hide();
					},
					'error': function (request, status, error) {
						console.log("error: " + status);
					},
					'success': function (response, status, request) {
						render(response);
					}
				}
			);
		}
		request();
	</script>
{% endblock %}
{% block body %}
	<div class="lead">
		<h1>{{ plugin.name }}</h1>
		<p>{{ plugin.description }}</p>
	</div>
	<table class="table">
		<thead></thead>
		<tbody></tbody>
		<tfoot></tfoot>
	</table>
	<p id="error"></p>
	<img id="spinwheel"
		 src="{{ url_for('static', filename='image/loading.gif') }}"
		 class="img-responsive center-block" />

{% endblock %}